<!DOCTYPE html>
<html lang="en" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Warrior Tasks Pro | Adamhgr</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --primary: #6366f1;
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --premium-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .dark-theme {
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
        }

        .rtl { direction: rtl; font-family: 'Cairo', sans-serif; }
        .rtl h1, .rtl h2, .rtl .btn-start, .rtl .fab { font-weight: 900 !important; }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg); overflow: hidden; position: fixed;
            font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.5s;
        }

        #stats-page {
            position: fixed; inset: 0; background: var(--bg); z-index: 4000;
            display: none; flex-direction: column; overflow-y: auto;
            padding-bottom: 100px;
        }

        .stats-card {
            background: var(--card); border: 1px solid var(--border);
            padding: 25px; border-radius: 30px; margin: 15px 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .stats-num { font-size: 32px; font-weight: 900; color: var(--primary); }
        .stats-label { font-size: 14px; color: var(--text-sub); font-weight: 700; }

        .overdue-tag {
            background: var(--danger); color: white; font-size: 10px;
            padding: 2px 8px; border-radius: 8px; font-weight: 900;
            margin-bottom: 5px; display: inline-block;
        }

        #alarm-screen {
            position: fixed; inset: 0; background: var(--primary); z-index: 30000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px;
        }
        .alarm-btn { 
            background: white; color: var(--primary); border: none; padding: 15px 40px; 
            border-radius: 20px; font-weight: 900; margin-top: 25px; cursor: pointer;
        }

        #app-notification {
            position: fixed; top: -100px; left: 20px; right: 20px;
            background: var(--warning); color: white; padding: 15px 20px;
            border-radius: 20px; z-index: 11000; display: flex; align-items: center;
            gap: 12px; box-shadow: 0 15px 30px rgba(245, 158, 11, 0.3);
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 700; font-size: 14px;
        }
        #app-notification.show { top: 60px; }

        #welcome-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 40px;
        }

        .welcome-logo { font-size: 80px; margin-bottom: 20px; filter: drop-shadow(0 10px 15px rgba(99,102,241,0.3)); }
        .btn-start { background: var(--primary); color: white; border: none; padding: 18px 60px; border-radius: 22px; font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: 0 10px 25px rgba(99,102,241,0.4); }

        #premium-page {
            position: fixed; inset: 0; background: var(--premium-gradient);
            z-index: 5000; display: none; flex-direction: column; color: white;
            padding: 40px 25px; text-align: center; overflow-y: auto;
        }

        .premium-card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.2);
            padding: 30px; margin-top: 30px; box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }

        .app-shell { height: 100vh; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); }

        .filter-wrapper { display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px; scrollbar-width: none; }
        .chip { padding: 8px 20px; background: var(--card); border: 1px solid var(--border); border-radius: 14px; font-size: 12px; font-weight: 700; color: var(--text-sub); white-space: nowrap; transition: 0.3s; cursor: pointer; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.1); }

        .progress-container { 
            background: linear-gradient(135deg, #818cf8, #6366f1); padding: 22px; 
            border-radius: 28px; color: white; margin: 0 20px 20px; 
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.3);
        }

        .progress-bar-bg { background: rgba(255,255,255,0.2); height: 10px; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-fill { background: white; height: 100%; border-radius: 10px; transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 0%; }

        .task-card { 
            background: var(--card); border-radius: 24px; padding: 20px; 
            margin: 0 20px 14px; display: flex; justify-content: space-between; 
            align-items: center; border: 1px solid var(--border); 
            transition: 0.3s;
        }
        .cat-tag { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--primary); letter-spacing: 1px; margin-bottom: 5px; display: inline-block; }
        .task-note { font-size: 12px; color: var(--text-sub); margin-top: 4px; font-style: italic; opacity: 0.8; }

        .nav { 
            position: fixed; bottom: 0; width: 100%; height: 90px; 
            background: var(--card); border-top: 1px solid var(--border); 
            display: flex; justify-content: space-around; align-items: center; 
            padding-bottom: env(safe-area-inset-bottom); z-index: 1000;
        }
        .nav-item { text-align: center; color: var(--text-sub); font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }

        .modal { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.6); z-index: 2000; 
            align-items: flex-end; backdrop-filter: blur(8px);
        }
        .modal-content { 
            background: var(--card); width: 100%; padding: 35px; 
            border-radius: 40px 40px 0 0; box-sizing: border-box; 
            color: var(--text-main);
        }

        input, select, textarea { 
            width: 100%; padding: 18px; border-radius: 20px; 
            border: 1px solid var(--border); background: var(--bg); 
            color: var(--text-main); font-family: inherit; margin-top: 10px; 
            outline: none; transition: 0.3s; resize: none;
        }

        .fab { 
            position: fixed; right: 25px; bottom: 120px; width: 68px; height: 68px; 
            background: var(--primary); border-radius: 25px; display: flex; 
            justify-content: center; align-items: center; color: white; 
            font-size: 35px; box-shadow: 0 15px 35px rgba(99,102,241,0.4); 
            z-index: 900; border: none; cursor: pointer;
        }

        #success-anim { 
            position: fixed; top: 15%; left: 50%; transform: translateX(-50%); 
            background: var(--success); color: white; padding: 15px 30px; 
            border-radius: 50px; font-weight: 800; z-index: 9999; display: none;
        }
        
        .btn-back {
            background: var(--border); color: var(--text-main); border: none; padding: 10px 20px;
            border-radius: 12px; font-weight: 800; cursor: pointer; margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="alarm-screen" class="animate__animated">
        <div style="font-size: 80px;">â°</div>
        <h1 id="alarm-title" style="margin: 10px 0;">Mission Time!</h1>
        <p id="alarm-desc" style="font-size: 18px; opacity: 0.9;">Take action now.</p>
        <button class="alarm-btn" id="btn-alarm-dismiss" onclick="dismissAlarm()">I'M ON IT!</button>
    </div>

    <div id="app-notification">
        <span>âš ï¸</span>
        <span id="notif-text">Quest starting soon!</span>
    </div>

    <div id="welcome-screen">
        <div class="welcome-logo animate__animated animate__bounceIn">âš”ï¸</div>
        <h1 id="welcome-title" class="animate__animated animate__fadeInUp" style="font-size: 38px; font-weight: 900; margin: 0;">WARRIOR PRO</h1>
        <p id="welcome-quote" class="animate__animated animate__fadeInUp animate__delay-1s" style="color: var(--text-sub); margin-bottom: 40px; padding: 0 20px;"></p>
        <button id="btn-begin" class="btn-start animate__animated animate__zoomIn animate__delay-2s" onclick="startApp()">BEGIN MISSION</button>
    </div>

    <div id="stats-page" class="animate__animated">
        <header style="padding: 35px 25px 15px;">
            <button class="btn-back" onclick="switchTab('home')">â† Back / Ø±Ø¬ÙˆØ¹</button>
            <br>
            <span id="stats-label-mode" style="color: var(--primary); font-weight: 800; font-size: 11px; letter-spacing: 3px;">WARRIOR ANALYTICS</span>
            <h1 id="stats-main-title" style="margin:0; font-size: 34px; font-weight: 900; color: var(--text-main);">Your Results</h1>
        </header>
        
        <div class="stats-card animate__animated animate__fadeInUp">
            <div class="stats-label" id="label-daily">Daily Evaluation (Today)</div>
            <div class="stats-num" id="daily-score">0%</div>
            <div class="progress-bar-bg" style="background: var(--bg);"><div id="daily-fill" class="progress-fill" style="background: var(--success);"></div></div>
            <p id="daily-motivation" style="font-size: 12px; margin-top: 10px; font-weight: 600; color: var(--primary);"></p>
        </div>

        <div class="stats-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
            <div class="stats-label" id="label-weekly">Weekly Evaluation (7 Days)</div>
            <div class="stats-num" id="weekly-score">0%</div>
            <div class="progress-bar-bg" style="background: var(--bg);"><div id="weekly-fill" class="progress-fill" style="background: var(--primary);"></div></div>
        </div>

        <div class="stats-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
            <div class="stats-label" id="label-total-missions">Total Missions Completed</div>
            <div class="stats-num" id="total-done-count">0</div>
        </div>
    </div>

    <div id="premium-page" class="animate__animated">
        <div style="text-align: right;"><button onclick="togglePremium(false)" style="background:none; border:none; color:white; font-size:40px;">&times;</button></div>
        <div class="animate__animated animate__pulse animate__infinite" style="font-size: 80px;">ğŸ‘‘</div>
        <h1 id="premium-title" style="font-size: 40px; font-weight: 900; margin-top: 10px;">Warrior Elite</h1>
        <div class="premium-card animate__animated animate__fadeInUp">
            <p id="premium-msg" style="font-weight: 600;">Contact Adamhgr for Lifetime Access</p>
            <button id="btn-upgrade" onclick="alert('Contact Adamhgr: 01062809046')" style="width: 100%; background: white; color: #4f46e5; border: none; padding: 20px; border-radius: 20px; font-weight: 900; cursor: pointer; margin-top: 10px;">UPGRADE NOW</button>
        </div>
    </div>

    <div id="success-anim">ğŸ”¥ MISSION ACCOMPLISHED!</div>

    <div class="app-shell" id="app-content" style="display:none;">
        <div id="home-view" style="display: contents;">
            <header style="padding: 35px 25px 15px;" class="animate__animated animate__fadeInDown">
                <span id="label-mode" style="color: var(--primary); font-weight: 800; font-size: 11px; letter-spacing: 10px;">WARRIOR MODE</span>
                <h1 id="main-title" style="margin:0; font-size: 34px; font-weight: 900; color: var(--text-main);">Daily Quests</h1>
            </header>

            <div class="filter-wrapper animate__animated animate__fadeInRight">
                <div id="filter-all" class="chip active" onclick="filterTasks('All', this)">All</div>
                <div id="filter-shop" class="chip" onclick="filterTasks('Shopping', this)">Shopping ğŸ›’</div>
                <div id="filter-work" class="chip" onclick="filterTasks('Work', this)">Work</div>
                <div id="filter-health" class="chip" onclick="filterTasks('Health', this)">Health</div>
                <div id="filter-study" class="chip" onclick="filterTasks('Study', this)">Study</div>
            </div>

            <div style="flex: 1; overflow-y: auto; padding-bottom: 120px;">
                <div class="progress-container animate__animated animate__zoomIn">
                    <div style="display:flex; justify-content:space-between; font-weight: 900;">
                        <span id="label-progress">Conquest Progress</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="progress-bar-bg"><div id="progress-fill" class="progress-fill"></div></div>
                </div>
                
                <div id="task-list"></div>
            </div>
        </div>

        <button class="fab animate__animated animate__bounceInUp" onclick="showModal('addModal')">ï¼‹</button>

        <nav class="nav">
            <div id="nav-home-btn" class="nav-item active" onclick="switchTab('home')">ğŸ <br><span id="nav-home">Home</span></div>
            <div id="nav-stats-btn" class="nav-item" onclick="switchTab('stats')">ğŸ“Š<br><span id="nav-stats">Stats</span></div>
            <div class="nav-item" onclick="togglePremium(true)">ğŸ’<br><span id="nav-premium">Premium</span></div>
            <div class="nav-item" onclick="showModal('settingsModal')">âš™ï¸<br><span id="nav-settings">Settings</span></div>
        </nav>
    </div>

    <div id="addModal" class="modal" onclick="if(event.target == this) hideModals()">
        <div class="modal-content animate__animated animate__slideInUp">
            <h2 id="modal-add-title" style="margin:0; font-weight:900;">Add Quest</h2>
            <input type="text" id="taskInput" placeholder="What is your mission?">
            <textarea id="taskNote" placeholder="Add a small note (optional)..." rows="2"></textarea>
            
            <div style="display:flex; gap:10px; margin-top: 10px;">
                <input type="date" id="taskDate" style="flex:1">
                <input type="time" id="taskTime" style="flex:1">
            </div>
            <select id="taskCat">
                <option value="General">General</option>
                <option value="Shopping">Shopping ğŸ›’</option>
                <option value="Work">Work</option>
                <option value="Health">Health</option>
                <option value="Study">Study</option>
            </select>
            <button id="btn-add-task" onclick="addTask()" style="background:var(--primary); color:white; width:100%; padding:20px; border:none; border-radius:22px; font-weight:900; margin-top:25px; cursor:pointer;">START QUEST</button>
        </div>
    </div>

    <div id="settingsModal" class="modal" onclick="if(event.target == this) hideModals()">
        <div class="modal-content animate__animated animate__slideInUp">
            <h2 id="modal-settings-title" style="margin-bottom:20px;">Settings</h2>
            <button id="btn-toggle-lang" onclick="toggleLanguage()" style="width:100%; padding:18px; border-radius:18px; border:1px solid var(--border); background:var(--primary); color:white; font-weight:900; margin-bottom: 15px;">English / Ù‚Ù„Ø¨Øª Ù…ØµØ±ÙŠ</button>
            <button id="btn-toggle-dark" onclick="toggleDark()" style="width:100%; padding:18px; border-radius:18px; border:1px solid var(--border); background:var(--bg); color:var(--text-main); font-weight:800; margin-bottom: 15px;">Toggle Dark Mode</button>
            <button id="btn-reset" onclick="resetData()" style="width:100%; background:var(--danger); color:white; padding:18px; border-radius:18px; border:none; font-weight:800;">Wipe All Data</button>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                welcomeTitle: "WARRIOR PRO", btnBegin: "BEGIN MISSION",
                mainTitle: "Daily Quests", labelMode: "WARRIOR MODE",
                filterAll: "All", filterShop: "Shopping ğŸ›’", filterWork: "Work", filterHealth: "Health", filterStudy: "Study",
                labelProgress: "Conquest Progress", navHome: "Home", navPremium: "Premium", navSettings: "Settings",
                modalAddTitle: "Add Quest", taskInput: "What is your mission?", taskNote: "Add a small note (optional)...", btnAddTask: "START QUEST",
                modalSettingsTitle: "Settings", btnToggleDark: "Toggle Dark Mode", btnReset: "Wipe All Data", btnToggleLang: "Switch to Arabic",
                successAnim: "ğŸ”¥ MISSION ACCOMPLISHED!", alarmTitle: "Mission Time!", btnAlarmDismiss: "I'M ON IT!",
                premiumTitle: "Warrior Elite", premiumMsg: "Contact Adamhgr for Lifetime Access", btnUpgrade: "UPGRADE NOW",
                navStats: "Stats", statsMainTitle: "Results", statsLabelMode: "WARRIOR ANALYTICS",
                labelDaily: "Daily Evaluation (Today)", labelWeekly: "Weekly Evaluation (7 Days)", labelTotalMissions: "Total Missions Completed",
                overdue: "MISSING FROM YESTERDAY âš ï¸",
                welcomeQuotes: ["Today is a new chance to be a hero!", "Warriors don't quit, they reset.", "Small steps leads to big victories."],
                motivateQuotes: ["Keep pushing, you're almost there!", "Success is earned, not given.", "Excellent progress today!"]
            },
            ar: {
                welcomeTitle: "Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ Ø¬Ø§Ù…Ø¯", btnBegin: "Ø¯ÙˆØ³ ÙŠØ§ Ø¨Ø·Ù„",
                mainTitle: "ÙˆØ±Ø§Ùƒ Ø¥ÙŠÙ‡ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©ØŸ", labelMode: "ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ­Ø´ Ø´ØºØ§Ù„",
                filterAll: "ÙƒÙ„Ùˆ", filterShop: "Ø·Ù„Ø¨Ø§Øª ğŸ›’", filterWork: "Ø´ØºÙ„", filterHealth: "ØµØ­Ø©", filterStudy: "Ù…Ø°Ø§ÙƒØ±Ø©",
                labelProgress: "Ø®Ù„ØµØª Ù‚Ø¯ Ø¥ÙŠÙ‡ØŸ", navHome: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", navPremium: "Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙ…", navSettings: "Ø¸Ø¨Ø· Ø­Ø§Ù„Ùƒ",
                modalAddTitle: "Ù‡ØªØ¹Ù…Ù„ Ø¥ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ØŸ", taskInput: "Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ù…Ø© Ù‡Ù†Ø§ ÙŠØ§ ÙˆØ­Ø´...", taskNote: "Ø¹Ø§ÙŠØ² ØªÙÙƒØ± Ù†ÙØ³Ùƒ Ø¨Ø­Ø§Ø¬Ø©ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", btnAddTask: "ÙŠÙ„Ø§ Ø§Ø¨Ø¯Ø£",
                modalSettingsTitle: "Ø§Ù„Ø¸Ø¨Ø·", btnToggleDark: "Ù†ÙˆØ± / Ø¶Ù„Ù…Ø©", btnReset: "ÙØ±Ù…Øª ÙƒÙ„ Ø­Ø§Ø¬Ø©", btnToggleLang: "Ù‚Ù„Ø¨ Ù„Ù€ English",
                successAnim: "ğŸ”¥ Ø¹Ø§Ø´ ÙŠØ§ ÙˆØ­Ø´.. Ø®Ù„ØµØªÙ‡Ø§!", alarmTitle: "ÙÙˆÙ‚ ÙŠØ§ Ø¨Ø·Ù„.. Ù…ÙŠØ¹Ø§Ø¯Ù†Ø§!", btnAlarmDismiss: "Ø£Ù†Ø§ ØµØ§Ø­ÙŠ Ù„Ù‡Ø§!",
                premiumTitle: "Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù„ÙˆÙƒ", premiumMsg: "ÙƒÙ„Ù… Adamhgr Ø¹Ø´Ø§Ù† ØªÙØ¹Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ù„Ø£Ø¨Ø¯", btnUpgrade: "Ø§Ø´ØªØ±Ùƒ Ø¯Ù„ÙˆÙ‚ØªÙŠ",
                navStats: "Ø§Ù„Ù†ØªØ§Ø¦Ø¬", statsMainTitle: "ØªÙ‚ÙŠÙŠÙ…Ùƒ ÙŠØ§ Ø¨Ø·Ù„", statsLabelMode: "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø±Ø¨",
                labelDaily: "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…", labelWeekly: "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (7 Ø£ÙŠØ§Ù…)", labelTotalMissions: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù…Ø§Øª Ø§Ù„Ù„ÙŠ Ø®Ù„ØµØª",
                overdue: "ÙØ§ÙŠØªØ§Ùƒ Ù…Ù† Ø§Ù…Ø¨Ø§Ø±Ø­ ÙŠØ§ Ø¨Ø·Ù„ âš ï¸",
                welcomeQuotes: ["Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø© ÙØ±ØµØ© Ø¬Ø¯ÙŠØ¯Ø© ØªÙƒÙˆÙ† Ø¨Ø·Ù„!", "Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ Ù…Ø¨ÙŠØ³ØªØ³Ù„Ù…Ø´ØŒ Ø¨ÙŠÙƒÙ…Ù„!", "Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø© Ø¨ØªØ¹Ù…Ù„ ÙØ±Ù‚ ÙƒØ¨ÙŠØ±."],
                motivateQuotes: ["Ø¹Ø§Ø´ ÙƒÙ…Ù„ØŒ Ù‚Ø±Ø¨Øª ØªÙˆØµÙ„!", "Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨ÙŠÙŠØ¬ÙŠ Ù„Ù„ÙŠ Ø¨ÙŠØªØ¹Ø¨ Ø¹Ù„Ø´Ø§Ù†Ù‡.", "Ù…Ø³ØªÙˆÙ‰ Ù‡Ø§ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©ØŒ Ø§Ø³ØªÙ…Ø±!"]
            }
        };

        let currentLang = localStorage.getItem('warrior_lang') || 'en';
        let tasks = JSON.parse(localStorage.getItem('warrior_tasks_v9')) || [];
        let notifiedTasks = [];
        let alarmAudio = null;

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ·ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        let warriorStats = JSON.parse(localStorage.getItem('warrior_evolution')) || {
            xp: 0,
            level: 1,
            streak: 0,
            lastDate: null,
            rank: "Novice"
        };

        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        function sendExternalNotification(title, body) {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") {
                new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/3112/3112946.png" });
            }
        }

        function updateLanguage() {
            const t = translations[currentLang];
            const html = document.getElementById('main-html');
            html.classList.toggle('rtl', currentLang === 'ar');
            html.lang = currentLang;

            document.getElementById('welcome-title').innerText = t.welcomeTitle;
            document.getElementById('btn-begin').innerText = t.btnBegin;
            document.getElementById('main-title').innerText = t.mainTitle;
            document.getElementById('label-mode').innerText = t.labelMode;
            document.getElementById('filter-all').innerText = t.filterAll;
            document.getElementById('filter-shop').innerText = t.filterShop;
            document.getElementById('filter-work').innerText = t.filterWork;
            document.getElementById('filter-health').innerText = t.filterHealth;
            document.getElementById('filter-study').innerText = t.filterStudy;
            document.getElementById('label-progress').innerText = t.labelProgress;
            document.getElementById('nav-home').innerText = t.navHome;
            document.getElementById('nav-stats').innerText = t.navStats;
            document.getElementById('nav-premium').innerText = t.navPremium;
            document.getElementById('nav-settings').innerText = t.navSettings;
            document.getElementById('modal-add-title').innerText = t.modalAddTitle;
            document.getElementById('taskInput').placeholder = t.taskInput;
            document.getElementById('taskNote').placeholder = t.taskNote;
            document.getElementById('btn-add-task').innerText = t.btnAddTask;
            document.getElementById('modal-settings-title').innerText = t.modalSettingsTitle;
            document.getElementById('btn-toggle-dark').innerText = t.btnToggleDark;
            document.getElementById('btn-reset').innerText = t.btnReset;
            document.getElementById('btn-toggle-lang').innerText = t.btnToggleLang;
            document.getElementById('success-anim').innerText = t.successAnim;
            document.getElementById('alarm-title').innerText = t.alarmTitle;
            document.getElementById('btn-alarm-dismiss').innerText = t.btnAlarmDismiss;
            document.getElementById('premium-title').innerText = t.premiumTitle;
            document.getElementById('premium-msg').innerText = t.premiumMsg;
            document.getElementById('btn-upgrade').innerText = t.btnUpgrade;
            document.getElementById('stats-main-title').innerText = t.statsMainTitle;
            document.getElementById('stats-label-mode').innerText = t.statsLabelMode;
            document.getElementById('label-daily').innerText = t.labelDaily;
            document.getElementById('label-weekly').innerText = t.labelWeekly;
            document.getElementById('label-total-missions').innerText = t.labelTotalMissions;

            const q = t.welcomeQuotes[Math.floor(Math.random() * t.welcomeQuotes.length)];
            document.getElementById('welcome-quote').innerText = q;

            localStorage.setItem('warrior_lang', currentLang);
            render();
        }

        function processTasksLogic() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const lastCleanup = localStorage.getItem('last_cleanup_date');

            tasks.forEach(t => {
                if (!t.done && t.date && t.date < todayStr) {
                    t.date = todayStr;
                    t.isOverdue = true;
                }
            });

            const dayOfWeek = now.getDay(); 
            if (dayOfWeek === 1 && lastCleanup !== todayStr) {
                 tasks = tasks.filter(t => !t.done);
                 localStorage.setItem('last_cleanup_date', todayStr);
            }
            save();
        }

        function playSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            if(type === 'victory') { osc.type = 'sine'; osc.frequency.setValueAtTime(500, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); }
            else if(type === 'alarm') { osc.type = 'square'; osc.frequency.setValueAtTime(440, ctx.currentTime); gain.gain.setValueAtTime(0.1, ctx.currentTime); return {osc, gain, ctx}; }
            else { osc.type = 'triangle'; osc.frequency.setValueAtTime(440, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.2); }
            gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
            osc.start(); osc.stop(ctx.currentTime + 0.4);
        }

        function triggerRealAlarm(task) {
            const screen = document.getElementById('alarm-screen');
            document.getElementById('alarm-title').innerText = task.text;
            const desc = task.note || (currentLang === 'ar' ? "ÙŠÙ„Ø§ ÙŠØ§ Ø¨Ø·Ù„ Ù…ÙÙŠØ´ ÙˆÙ‚Øª!" : "Mission starts now!");
            document.getElementById('alarm-desc').innerText = desc;
            screen.style.display = 'flex'; screen.className = 'animate__animated animate__fadeIn';
            alarmAudio = playSound('alarm'); alarmAudio.osc.start();
            sendExternalNotification(task.text, desc);
        }

        function dismissAlarm() {
            if(alarmAudio) { alarmAudio.osc.stop(); alarmAudio.ctx.close(); alarmAudio = null; }
            const screen = document.getElementById('alarm-screen');
            screen.className = 'animate__animated animate__fadeOut';
            setTimeout(() => screen.style.display = 'none', 500);
        }

        function checkDeadlines() {
            const now = new Date();
            const currentTimeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const currentDateStr = now.toISOString().split('T')[0];
            tasks.forEach(t => {
                if(t.done || !t.date || !t.time) return;
                const [y, m, d] = t.date.split('-'); const [h, min] = t.time.split(':');
                const diffMins = Math.floor((new Date(y, m-1, d, h, min) - now) / 60000);
                if(diffMins <= 60 && diffMins > 0 && !notifiedTasks.includes(t.id + '_pre')) {
                    const msg = currentLang === 'ar' ? `ÙÙˆÙ‚! Ù…Ù‡Ù…Ø© "${t.text}" Ù‡ØªØ¨Ø¯Ø£ ÙƒÙ…Ø§Ù† ${diffMins} Ø¯Ù‚Ø§ÙŠÙ‚.` : `Get ready! "${t.text}" starts in ${diffMins} mins.`;
                    showAppNotification(msg); 
                    sendExternalNotification(currentLang === 'ar' ? "ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…Ø© Ù‚Ø±ÙŠØ¨Ø©" : "Upcoming Quest", msg);
                    notifiedTasks.push(t.id + '_pre'); playSound('alert');
                }
                if(t.date === currentDateStr && t.time === currentTimeStr && !notifiedTasks.includes(t.id + '_now')) { triggerRealAlarm(t); notifiedTasks.push(t.id + '_now'); }
            });
        }

        function showAppNotification(msg) {
            const el = document.getElementById('app-notification');
            document.getElementById('notif-text').innerText = msg;
            el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 6000);
        }

        setInterval(checkDeadlines, 5000); 

        function startApp() {
            requestNotificationPermission();
            processTasksLogic();
            const screen = document.getElementById('welcome-screen');
            screen.classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => { 
                screen.style.display = 'none'; document.getElementById('app-content').style.display = 'flex'; updateLanguage();
                updateEvolution();
            }, 600);
        }

        function switchTab(tab) {
            const homeView = document.getElementById('home-view');
            const statsPage = document.getElementById('stats-page');
            const navHome = document.getElementById('nav-home-btn');
            const navStats = document.getElementById('nav-stats-btn');

            if(tab === 'home') {
                homeView.style.display = 'contents';
                statsPage.style.display = 'none';
                navHome.classList.add('active');
                navStats.classList.remove('active');
            } else {
                homeView.style.display = 'none';
                statsPage.style.display = 'flex';
                statsPage.className = 'animate__animated animate__fadeIn';
                navHome.classList.remove('active');
                navStats.classList.add('active');
                calculateStats();
                displayEvolution();
            }
        }

        function calculateStats() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(now.getDate() - 7);

            const dailyTasks = tasks.filter(t => t.date === todayStr);
            const dailyDone = dailyTasks.filter(t => t.done).length;
            const dailyPercent = dailyTasks.length ? Math.round((dailyDone/dailyTasks.length)*100) : 0;

            const weeklyTasks = tasks.filter(t => t.date && new Date(t.date) >= oneWeekAgo);
            const weeklyDone = weeklyTasks.filter(t => t.done).length;
            const weeklyPercent = weeklyTasks.length ? Math.round((weeklyDone/weeklyTasks.length)*100) : 0;

            document.getElementById('daily-score').innerText = dailyPercent + '%';
            document.getElementById('daily-fill').style.width = dailyPercent + '%';
            document.getElementById('weekly-score').innerText = weeklyPercent + '%';
            document.getElementById('weekly-fill').style.width = weeklyPercent + '%';
            document.getElementById('total-done-count').innerText = tasks.filter(t => t.done).length;

            const t = translations[currentLang];
            document.getElementById('daily-motivation').innerText = t.motivateQuotes[Math.floor(Math.random() * t.motivateQuotes.length)];
        }

        function togglePremium(show) {
            const page = document.getElementById('premium-page');
            if(show) { page.style.display = 'flex'; page.className = 'animate__animated animate__fadeInUp'; }
            else { page.className = 'animate__animated animate__fadeOutDown'; setTimeout(() => page.style.display = 'none', 500); }
        }

        function showModal(id) { document.getElementById(id).style.display = 'flex'; }
        function hideModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function toggleDark() { document.getElementById('main-html').classList.toggle('dark-theme'); hideModals(); }
        function toggleLanguage() { currentLang = currentLang === 'en' ? 'ar' : 'en'; updateLanguage(); hideModals(); }

        function resetData() {
            if(confirm(currentLang === 'ar' ? "Ù‡ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„ØªÙ‡ ÙŠØ§ ÙˆØ­Ø´ØŸ" : "Wipe all missions?")) { localStorage.clear(); location.reload(); }
        }

        // --- ØªØ¹Ø¯ÙŠÙ„ addTask Ù„ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø°ÙƒÙŠ ---
        function addTask() {
            let input = document.getElementById('taskInput');
            if(!input.value) return;

            const emojis = {
                'Ù…Ø°Ø§ÙƒØ±Ø©': 'ğŸ“š', 'Ø¯Ø±Ø³': 'ğŸ“', 'gym': 'ğŸ‹ï¸', 'Ø¬ÙŠÙ…': 'ğŸ’ª', 
                'Ø£ÙƒÙ„': 'ğŸ', 'Ø´Ø±Ø¨': 'ğŸ’§', 'Ù†ÙˆÙ…': 'ğŸ˜´', 'ØµÙ„Ø§Ø©': 'ğŸ•Œ',
                'work': 'ğŸ’¼', 'Ø´ØºÙ„': 'ğŸ’»', 'Ù‚Ø±Ø§Ø¡Ø©': 'ğŸ“–', 'shop': 'ğŸ›’', 'ØªØ³ÙˆÙ‚': 'ğŸ›’'
            };
            
            for (let key in emojis) {
                if (input.value.toLowerCase().includes(key) && !input.value.includes(emojis[key])) {
                    input.value = emojis[key] + " " + input.value;
                    break;
                }
            }

            tasks.unshift({ 
                id: Date.now(), 
                text: input.value, 
                note: document.getElementById('taskNote').value, 
                date: document.getElementById('taskDate').value || new Date().toISOString().split('T')[0], 
                time: document.getElementById('taskTime').value, 
                cat: document.getElementById('taskCat').value, 
                done: false,
                isOverdue: false 
            });
            input.value = ''; document.getElementById('taskNote').value = ''; hideModals(); render();
            updateEvolution();
        }

        function completeTask(id) {
            const idx = tasks.findIndex(t => t.id === id); 
            tasks[idx].done = true; 
            tasks[idx].isOverdue = false; 
            playSound('victory');
            const anim = document.getElementById('success-anim'); anim.style.display = 'block'; anim.className = 'animate__animated animate__bounceInDown';
            setTimeout(() => { anim.classList.replace('animate__bounceInDown', 'animate__fadeOutUp'); setTimeout(() => anim.style.display = 'none', 500); }, 1000);
            render();
            updateEvolution();
        }

        function deleteTask(id, el) {
            el.closest('.task-card').classList.add('animate__animated', 'animate__zoomOut');
            setTimeout(() => { tasks = tasks.filter(t => t.id !== id); render(); updateEvolution(); }, 300);
        }

        function save() {
            localStorage.setItem('warrior_tasks_v9', JSON.stringify(tasks));
        }

        // --- Ù…Ù†Ø·Ù‚ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ·ÙˆØ± (XP, Streak, Levels) ---
        function updateEvolution() {
            const xpPerTask = 20;
            const totalDone = tasks.filter(t => t.done).length;
            warriorStats.xp = totalDone * xpPerTask;
            
            warriorStats.level = Math.floor(warriorStats.xp / 100) + 1;
            
            const ranksEn = ["Novice", "Soldier", "Knight", "Commander", "Legendary"];
            const ranksAr = ["Ù…Ø¨ØªØ¯Ø¦", "Ø¬Ù†Ø¯ÙŠ", "ÙØ§Ø±Ø³", "Ù‚Ø§Ø¦Ø¯", "Ø£Ø³Ø·ÙˆØ±Ø©"];
            const activeRanks = currentLang === 'ar' ? ranksAr : ranksEn;
            warriorStats.rank = activeRanks[Math.min(warriorStats.level - 1, activeRanks.length - 1)];

            const today = new Date().toISOString().split('T')[0];
            if (warriorStats.lastDate !== today && totalDone > 0) {
                warriorStats.streak++;
                warriorStats.lastDate = today;
            }
            
            localStorage.setItem('warrior_evolution', JSON.stringify(warriorStats));
        }

        function displayEvolution() {
            const statsPage = document.getElementById('stats-page');
            if (!document.getElementById('evo-section')) {
                const evoHTML = `
                    <div id="evo-section" class="stats-card animate__animated animate__fadeInUp" style="background: var(--premium-gradient); color: white; border:none;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div class="stats-label" style="color: rgba(255,255,255,0.8); font-size:10px;">RANK: <span id="evo-rank" style="font-weight:900; color:white;"></span></div>
                                <div class="stats-num" id="evo-level" style="color: white; font-size:28px;">Lvl 1</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size: 24px;">ğŸ”¥ <span id="evo-streak">0</span></div>
                                <div style="font-size: 9px; font-weight:900; opacity:0.8;">DAY STREAK</div>
                            </div>
                        </div>
                        <div class="progress-bar-bg" style="background: rgba(255,255,255,0.2); margin-top:15px; height:8px;">
                            <div id="evo-xp-fill" class="progress-fill" style="background: white; width: 0%;"></div>
                        </div>
                        <p id="evo-msg" style="font-size: 11px; margin-top: 10px; font-weight:700; opacity:0.9;"></p>
                    </div>
                `;
                statsPage.children[1].insertAdjacentHTML('afterend', evoHTML);
            }

            document.getElementById('evo-level').innerText = "Lvl " + warriorStats.level;
            document.getElementById('evo-rank').innerText = warriorStats.rank;
            document.getElementById('evo-streak').innerText = warriorStats.streak;
            document.getElementById('evo-xp-fill').style.width = (warriorStats.xp % 100) + "%";
            
            const nextLvl = 100 - (warriorStats.xp % 100);
            document.getElementById('evo-msg').innerText = currentLang === 'ar' ? 
                `Ø¨Ø§Ù‚ÙŠ ${nextLvl} Ù†Ù‚Ø·Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ!` : 
                `${nextLvl} XP left for next level!`;
        }

        function render() {
            const list = document.getElementById('task-list'); list.innerHTML = '';
            const tText = translations[currentLang];
            
            tasks.forEach(t => {
                const doneLabel = currentLang === 'ar' ? 'Ø®Ù„ØµØª' : 'Done';
                const noDateLabel = currentLang === 'ar' ? 'Ù…ÙÙŠØ´ ÙˆÙ‚Øª' : 'No Date';
                list.innerHTML += `<div class="task-card animate__animated animate__fadeInLeft">
                        <div style="flex:1">
                            ${t.isOverdue && !t.done ? `<span class="overdue-tag">${tText.overdue}</span>` : ''}
                            <span class="cat-tag">${t.cat}</span>
                            <div style="font-weight:800; font-size:17px; ${t.done ? 'text-decoration:line-through; opacity:0.4;' : ''}">${t.text}</div>
                            ${t.note ? `<div class="task-note">${t.note}</div>` : ''}
                            <div style="font-size:11px; color:var(--text-sub); margin-top:5px; font-weight:700;">ğŸ“… ${t.date || noDateLabel} â€¢ â° ${t.time || '--:--'}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap: 10px;">
                            ${!t.done ? `<button onclick="completeTask(${t.id})" style="background:var(--success); color:white; border:none; padding:10px 18px; border-radius:12px; font-weight:800; cursor:pointer;">${doneLabel}</button>` : 'â­'}
                            <button onclick="deleteTask(${t.id}, this)" style="background:none; border:none; color:var(--danger); font-size:24px; cursor:pointer;">&times;</button>
                        </div>
                    </div>`;
            });
            
            const totalDone = tasks.filter(t => t.done).length;
            const percent = tasks.length ? Math.round((totalDone/tasks.length)*100) : 0;
            document.getElementById('progress-percent').innerText = percent + '%';
            document.getElementById('progress-fill').style.width = percent + '%';
            save();
        }

        window.onload = updateLanguage;
// --- Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙˆÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ---

// 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ (Navigation)
const navBar = document.querySelector('.nav');
if (navBar && !document.getElementById('nav-timer-btn')) {
    const timerBtnHTML = `
        <div id="nav-timer-btn" class="nav-item" onclick="switchTab('focus')">
            â±ï¸<br><span id="nav-timer-text">Focus</span>
        </div>
    `;
    navBar.insertAdjacentHTML('afterbegin', timerBtnHTML);
}

// 2. Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙˆÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ù‡ÙŠÙƒÙ„ (HTML)
const appShell = document.querySelector('.app-shell');
const focusPageHTML = `
    <div id="focus-page" style="display:none; flex:1; flex-direction:column; align-items:center; justify-content:center; padding:20px; text-align:center;" class="animate__animated">
        <div id="silent-overlay" style="display:none; position:fixed; inset:0; background:var(--bg); z-index:100; justify-content:center; align-items:center; flex-direction:column;">
             <h2 style="color:var(--primary); font-weight:900;">SILENT MODE ON ğŸ¤«</h2>
             <p style="color:var(--text-sub);">Concentrate on your mission...</p>
             <div id="silent-task-display" style="font-size:24px; font-weight:900; margin:20px;"></div>
             <button onclick="toggleSilent(false)" style="background:var(--danger); color:white; border:none; padding:15px 30px; border-radius:15px; font-weight:800;">Break Silence</button>
        </div>

        <h1 style="font-weight:900; margin-bottom:10px;">WARRIOR TIMER</h1>
        <div id="timer-display" style="font-size: 80px; font-weight: 900; color: var(--primary); font-family: monospace; margin: 20px 0; text-shadow: 0 10px 20px rgba(99,102,241,0.2);">25:00</div>
        
        <div style="display:flex; gap:15px; margin-bottom:30px;">
            <button id="timer-start" onclick="startPomodoro()" style="background:var(--success); color:white; border:none; padding:15px 30px; border-radius:20px; font-weight:900; cursor:pointer;">START</button>
            <button id="timer-reset" onclick="resetPomodoro()" style="background:var(--border); color:var(--text-main); border:none; padding:15px 30px; border-radius:20px; font-weight:900; cursor:pointer;">RESET</button>
        </div>

        <div class="stats-card" style="width:80%; background:var(--card); border-radius:25px;">
            <p id="timer-status" style="font-weight:800; color:var(--text-sub);">READY FOR WORK?</p>
            <button onclick="toggleSilent(true)" style="width:100%; background:var(--text-main); color:var(--bg); border:none; padding:12px; border-radius:12px; font-weight:900; margin-top:10px;">ACTIVATE SILENT MODE</button>
        </div>
    </div>
`;
appShell.insertAdjacentHTML('beforeend', focusPageHTML);

// 3. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ§ÙŠÙ…Ø± (Logic)
let timerInterval;
let timeLeft = 25 * 60;
let isBreak = false;

function updateTimerDisplay() {
    const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const secs = (timeLeft % 60).toString().padStart(2, '0');
    document.getElementById('timer-display').innerText = `${mins}:${secs}`;
}

function startPomodoro() {
    if (timerInterval) return;
    document.getElementById('timer-start').innerText = "RUNNING...";
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            isBreak = !isBreak;
            timeLeft = isBreak ? 5 * 60 : 25 * 60;
            document.getElementById('timer-status').innerText = isBreak ? "REST TIME! â˜•" : "BACK TO WORK! âš”ï¸";
            alert(isBreak ? "Break Time!" : "Back to Work!");
            updateTimerDisplay();
        }
    }, 1000);
}

function resetPomodoro() {
    clearInterval(timerInterval);
    timerInterval = null;
    timeLeft = 25 * 60;
    isBreak = false;
    document.getElementById('timer-start').innerText = "START";
    document.getElementById('timer-status').innerText = "READY FOR WORK?";
    updateTimerDisplay();
}

function toggleSilent(on) {
    const overlay = document.getElementById('silent-overlay');
    if(on) {
        const firstTask = tasks.find(t => !t.done);
        document.getElementById('silent-task-display').innerText = firstTask ? `FOCUSING ON: ${firstTask.text}` : "No Active Missions";
        overlay.style.display = 'flex';
    } else {
        overlay.style.display = 'none';
    }
}

// 4. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© switchTab Ù„ØªØ¯Ø¹Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const originalSwitchTab = switchTab;
switchTab = function(tab) {
    const focusPage = document.getElementById('focus-page');
    const homeView = document.getElementById('home-view');
    const statsPage = document.getElementById('stats-page');
    const navTimer = document.getElementById('nav-timer-btn');

    if(tab === 'focus') {
        homeView.style.display = 'none';
        statsPage.style.display = 'none';
        focusPage.style.display = 'flex';
        focusPage.className = 'animate__animated animate__fadeIn';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        navTimer.classList.add('active');
        if(currentLang === 'ar') {
            document.getElementById('nav-timer-text').innerText = "Ø§Ù„ØªØ±ÙƒÙŠØ²";
            document.getElementById('timer-status').innerText = "Ù…Ø³ØªØ¹Ø¯ Ù„Ù„Ø´ØºÙ„ØŸ";
        }
    } else {
        focusPage.style.display = 'none';
        navTimer.classList.remove('active');
        originalSwitchTab(tab);
    }
};

    </script>
<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ PWA (Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ ÙƒØªØ·Ø¨ÙŠÙ‚)
    if ('serviceWorker' in navigator) {
        const swBlob = new Blob([`
            self.addEventListener('fetch', function(event) {
                event.respondWith(fetch(event.request));
            });
        `], {type: 'text/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl);
    }

    // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ Manifest (Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ù„Ùƒ "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
    const manifest = {
        "name": "Warrior Elite HQ",
        "short_name": "Warrior",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#02040a",
        "theme_color": "#a78bfa",
        "icons": [{
            "src": "https://cdn-icons-png.flaticon.com/512/1067/1067357.png",
            "sizes": "512x512",
            "type": "image/png"
        }]
    };
    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);

    // 3. Ø¥Ø¶Ø§ÙØ© ØªØ­Ø±ÙŠÙƒØ§Øª Ø§Ù„Ù€ Premium CSS Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
    const premiumStyles = `
        @keyframes shimmer {
            0% { left: -150%; }
            100% { left: 150%; }
        }
        .royal-card { position: relative; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important; }
        .royal-card::after {
            content: ""; position: absolute; top: 0; left: -150%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.08), transparent);
            transform: skewX(-25deg); animation: shimmer 4s infinite;
        }
        .royal-card:active { transform: scale(0.96) !important; }
        .timer-circle { transition: all 0.5s ease; }
        .timer-running { animation: pulseGlow 2s infinite ease-in-out; }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.2); }
            50% { box-shadow: 0 0 50px rgba(167, 139, 250, 0.5); }
            100% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.2); }
        }
    `;
    const styleSheet = document.createElement("style");
    styleSheet.innerText = premiumStyles;
    document.head.appendChild(styleSheet);

    // 4. Ø±Ø¨Ø· ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØªØ§ÙŠÙ…Ø± Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ØµÙ„ÙŠ
    const originalToggleTimer = toggleTimer;
    toggleTimer = function() {
        const circle = document.querySelector('.timer-circle');
        originalToggleTimer();
        if (tRun) circle.classList.add('timer-running');
        else circle.classList.remove('timer-running');
    };
</script>
<script>
// --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ---

// 1. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† ÙÙˆØ± ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function requestNotificationPermission() {
    if ("Notification" in window) {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Notification system active.");
            }
        });
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
function sendExternalNotification(title, body) {
    if ("Notification" in window && Notification.permission === "granted") {
        navigator.serviceWorker.ready.then(registration => {
            registration.showNotification(title, {
                body: body,
                icon: "https://cdn-icons-png.flaticon.com/512/1067/1067357.png", // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø­Ø§Ø±Ø¨
                badge: "https://cdn-icons-png.flaticon.com/512/1067/1067357.png",
                vibrate: [200, 100, 200],
                tag: 'warrior-elite-notif'
            });
        });
    }
}

// 3. Ø±Ø¨Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ø¹Ù†Ø¯ Ø¥ØªÙ…Ø§Ù… Ù…Ù‡Ù…Ø©)
const originalCompleteTask = completeTask;
completeTask = function(id) {
    const task = tasks.find(t => t.id === id);
    originalCompleteTask(id);
    sendExternalNotification("ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ”¥", `Ø¹Ø§Ø´ ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø®Ù„ØµØª: ${task.text}`);
};

// 4. ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©)
setInterval(() => {
    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    
    tasks.forEach(t => {
        if (!t.done && t.time === currentTime) {
            sendExternalNotification("Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„! âš”ï¸", `Ù…Ù‡Ù…Ø© Ø§Ù„Ø¢Ù†: ${t.text}`);
        }
    });
}, 60000);

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
requestNotificationPermission();


// --- Optimized Timer & Focus Engine ---

let timerInterval;
let timeLeft = 25 * 60;
let isBreak = false;

function updateTimerDisplay() {
    const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const secs = (timeLeft % 60).toString().padStart(2, '0');
    const display = document.getElementById('timer-display');
    if(display) display.innerText = `${mins}:${secs}`;
}

function startPomodoro() {
    const btn = document.getElementById('timer-start');
    const circle = document.getElementById('timer-display');

    if (timerInterval) {
        // Toggle Pause
        clearInterval(timerInterval);
        timerInterval = null;
        btn.innerText = currentLang === 'ar' ? "Ø§Ø³ØªØ¦Ù†Ø§Ù" : "RESUME";
        circle.classList.remove('timer-running');
    } else {
        // Start/Resume
        btn.innerText = currentLang === 'ar' ? "Ø´ØºØ§Ù„..." : "RUNNING...";
        circle.classList.add('timer-running');
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                isBreak = !isBreak;
                timeLeft = isBreak ? 5 * 60 : 25 * 60;
                const msg = isBreak ? "Rest Time! â˜•" : "Back to Work! âš”ï¸";
                document.getElementById('timer-status').innerText = msg;
                sendExternalNotification("Timer Update", msg);
                playSound('alert');
                updateTimerDisplay();
            }
        }, 1000);
    }
}

// Ensure switchTab handles the translation update for the Focus page
const originalSwitchTab = switchTab;
switchTab = function(tab) {
    const focusPage = document.getElementById('focus-page');
    const navTimer = document.getElementById('nav-timer-btn');
    
    if(tab === 'focus') {
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('stats-page').style.display = 'none';
        focusPage.style.display = 'flex';
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        navTimer.classList.add('active');
        
        // Dynamic Translation for Focus Tab
        document.getElementById('nav-timer-text').innerText = currentLang === 'ar' ? "ØªØ±ÙƒÙŠØ²" : "Focus";
        updateTimerDisplay();
    } else {
        focusPage.style.display = 'none';
        originalSwitchTab(tab);
    }
};
	</script>
</body>
</html>
